# 拜耳GMP报告生成器插件测试指南

本文档提供了拜耳GMP报告生成器插件的测试场景和触发指令，帮助您在Dify平台上进行全面测试。

## LLM系统提示词

以下是您可以直接复制到Dify系统提示词设置中的内容：

```
您是拜耳GMP报告生成助手，负责通过自然对话方式收集生成标准GMP调查报告所需的关键信息。请使用专业且友好的语气引导用户提供以下信息：

### 基本信息
**参考信息:**
- **参考SOP编号 (refSop)**: 格式如"GMP-SMP00019"或"GMP-MFG00022"
- **文档ID (docId)**: 格式如"FORM-GMP-SMP0019-A02"
- **版本号 (version)**: 格式如"3.0"或"2.5"

**报告识别:**
- **报告标题 (title)**: 例如"DS101问题调查报告"、"生产过程偏差调查报告"
- **调查ID (investigationId)**: 格式如"CADKM2023-88"
- **准备人员 (preparedBy)**: 报告撰写人全名
- **准备日期 (preparedDate)**: 格式必须为YYYY-MM-DD，如"2025-03-28"

### 事件描述 (Event Description)
- **设备名称**: 发生故障的设备名称是什么？
- **设备编号**: 设备的唯一标识编号是什么？
- **故障时间**: 设备故障发生的具体时间 (YYYY-MM-DD HH:mm)
- **发现人**: 谁首先发现了设备故障？
- **故障现象**: 请简要描述故障的表现或异常情况，例如"设备无法启动"、"运行中突然停机"等

### 初步影响评估 (Preliminary Impact Assessment)
- **受影响的产品/批次**: 是否有产品或批次受到影响？如果有，请列出相关批次号
- **对生产的影响**: 设备故障是否导致生产停工？如果是，停工时长是多少？
- **对质量的潜在影响**: 设备故障是否可能导致产品质量问题？例如污染、偏差等

### 根本原因分析
- **分析方法**: 采用什么方法进行根本原因分析？例如"5Why分析"、"FMEA分析"等
- **可能的原因**: 列出可能导致故障的原因（如设备老化、维护不足等）
- **确认的根本原因**: 通过调查最终确认的根本原因是什么？

### 纠正与预防措施 (Corrective and Preventive Actions, CAPA)
- **纠正措施**: 针对此次故障采取了哪些立即的纠正措施？例如更换零件、修复设备等
- **预防措施**: 为了防止类似故障再次发生，计划采取哪些长期措施？例如加强培训、优化维护计划等

### 结论与关闭 (Conclusion and Closure)
- **结论**: 最终此次调查的结果和影响
- **关闭声明**: 是否可以正式关闭此次调查？如果可以，请提供关闭声明

请根据用户描述的问题类型，灵活调整提问方式。如用户一次提供了多项信息，请先确认已获取的内容，然后自然地引导用户补充缺失信息。

始终记住GMP报告的专业性和准确性要求，确保收集的信息符合制药行业标准。如遇专业术语，请理解并正确使用，不要擅自更改专业表述。

如果用户要求查看当前收集的信息摘要，请以Markdown表格格式提供当前已收集的信息，分组显示，并标注哪些信息还缺失。
```

## 测试场景

### 场景1：无菌灌装线故障

**用户输入：**
```
我需要记录一起无菌灌装线故障事件。灌装线(FL-301)在2025年4月12日上午9:30发生了输送带卡住故障，导致一批次产品的灌装被中断。操作员陈刚在巡检中发现并立即按下紧急停止按钮。经过排查，发现是输送带齿轮磨损导致的错位。维修团队更换了齿轮并对整条输送系统进行了全面检查。此次故障影响了批号BLF-2025041201约30分钟的生产时间，但未造成产品质量问题，所有已灌装的产品都符合质量要求。
```

**补充信息：**
```
参考SOP是GMP-PRD00137，文档ID是FORM-GMP-PRD-F03，版本4.0。
报告标题是"无菌灌装线故障调查报告"，调查ID是PRDINV-2025-04-15。
报告由我（王恒辉）撰写，日期是2025-04-15。

我们使用了5Why分析方法进行根本原因调查，发现齿轮磨损是由于缺乏定期润滑和检查导致的。主要原因是灌装线润滑计划执行不到位，相关操作员未严格按照SOP执行维护。

为防止类似问题，我们采取了以下措施：
1. 更新了输送系统维护SOP，增加了齿轮检查和润滑的频率
2. 为维护团队开展了SOP培训
3. 在灌装线引入了自动润滑系统
4. 建立了设备关键部件更换提醒系统

本次事件属于1级偏差，仅影响生产效率，不影响产品质量。调查结果表明所有补救措施已实施，建议正式关闭本次调查。
```

### 场景2：原料药合成反应偏差

**用户输入：**
```
我们在2025年5月3日的原料药合成批次中发现了一个工艺偏差，需要记录并调查。合成反应器RC-105的温度控制在第二步反应中出现波动，温度在设定值130±2°C的范围外波动，最高达到134.5°C，持续了约15分钟。工艺操作员李明在监控系统中发现异常并通知了主管。质量部门审核后决定将该批次(批号：API-20250503-B17)隔离等待进一步调查。
```

**补充信息：**
```
参考SOP编号是GMP-API00089，文档ID是FORM-GMP-API-D15，版本3.2。
报告标题是"原料药合成反应温度偏差调查报告"，调查ID是APIDEV-2025-05-21。
由质量保证专员张丽华准备，日期2025-05-21。

我们使用FMEA和过程回顾方法分析了此次温度偏差。调查发现造成温度波动的原因是温度传感器校准偏差与PID控制参数设置不当的组合影响。在近期一次维护后，PID参数被重置但未按照工艺要求重新优化。

影响评估显示，虽然温度短暂超出工艺范围，但根据历史研发数据和稳定性研究，此温度范围不会对API关键质量属性产生影响。批次检测结果显示所有质量指标符合规格要求，可以放行使用。此偏差评估为2级偏差。

我们采取的措施包括：
1. 重新校准温度传感器
2. 优化并锁定PID控制参数
3. 修订维护程序，增加PID参数确认步骤
4. 升级控制系统报警功能，设置提前预警
5. 培训工程师和操作员有关温度控制系统的知识

基于全面调查和测试批次的质量结果，建议放行此批次并关闭调查。
```

### 场景3：包装材料供应商偏差

**用户输入：**
```
我需要报告一个包装材料供应商偏差问题。2025年6月10日，我们收到了供应商Packwell Inc.提供的铝箔包装材料(物料编号：PM-ALF-2022)，批号PWI-20250605。质检部门在进厂检验时发现材料厚度为19.2微米，不符合规格要求的20±0.5微米。质检员王强立即将该批次材料标记为待确认状态并通知了质量保证部门。供应商已被告知此问题，并要求提供解释。
```

**补充信息：**
```
参考SOP是GMP-QA00156，文档ID是FORM-GMP-QA-S09，版本2.8。
报告标题是"包装材料质量偏差调查报告"，调查ID是QADEV-2025-06-15。
报告由质量经理刘海燕准备，日期是2025-06-15。

调查采用了供应商审计和根本原因分析方法。我们与供应商进行了视频会议，并要求提供生产记录。发现供应商在生产此批次时更换了一条生产线，但未按照变更管理程序通知客户和验证工艺参数。

这批材料共计500公斤，全部被隔离，未用于生产。因此对产品质量无影响。但如果使用，可能会影响包装完整性和产品的水分保护。供应商已经提供了偏差解释报告和纠正预防措施计划。

我们采取的行动包括：
1. 拒收并退回不合格批次
2. 要求供应商提供CAPA计划
3. 修订供应商质量协议，明确变更通知要求
4. 安排对供应商的现场审计
5. 临时加强对该供应商后续三批产品的检验频率

对供应商评级进行了调整，并将进行为期6个月的密切监控。建议关闭此调查，但维持供应商强化监控状态。
```

### 场景4：实验室设备校准偏差

**用户输入：**
```
我们的质控实验室在2025年7月8日发现HPLC系统(设备编号：QC-HPLC-08)的流速校准结果超出了可接受标准。按照SOP要求，流速偏差应在±1%以内，但校准显示偏差达到了1.8%。设备维护记录显示该设备上次校准是在2025年1月5日，有效期为6个月，已经过期3天。分析员张小燕在执行常规校准时发现了此问题，并立即通知了实验室主管。
```

**补充信息：**
```
参考SOP编号是GMP-QC00078，文档ID是FORM-GMP-QC-C12，版本3.5。
报告标题是"实验室设备校准偏差调查报告"，调查ID是QCDEV-2025-07-12。
由QC主管李志明准备，日期2025-07-12。

我们回顾了设备管理系统和校准记录，发现校准提醒系统未能正常发出警报。根本原因是IT系统在6月进行升级后，校准提醒功能配置丢失。这导致多台设备的校准提醒未被正常发送。

我们对过去3个月使用该HPLC系统测试的所有样品结果进行了回顾分析。根据偏差程度和方法验证数据，1.8%的流速偏差可能对分析结果产生±1.2%的影响，这在方法精密度允许范围内。质量评估认为此偏差不会对产品质量判定产生实质影响。

采取的纠正预防措施包括：
1. 立即重新校准HPLC系统及所有过期设备
2. 修复IT系统中的校准提醒功能
3. 实施每周校准状态人工审核机制
4. 更新IT变更控制程序，增加关键功能确认步骤
5. 培训实验室人员关注设备校准状态

所有受影响设备已完成校准，IT系统问题已修复。建议关闭此调查。
```

### 场景5：环境监测偏差

**用户输入：**
```
我们在B级洁净区(房间号CR-B-205)的例行环境监测中发现了一个偏差。2025年8月20日的浮游菌监测结果显示，一个采样点(EM-B-205-03)的浮游菌数为12 CFU/m³，超过了B级区的警戒限值(10 CFU/m³)。环境监测技术员周明在8月21日获得培养结果时立即通知了QA部门。此区域用于无菌原料的配置，8月20日有一批次(BN-20250820-04)在生产过程中。
```

**补充信息：**
```
参考SOP是GMP-QA00123，文档ID是FORM-GMP-QA-E07，版本4.1。
报告标题是"洁净区环境监测偏差调查报告"，调查ID是EMDEV-2025-08-25。
报告由QA专员王晓梅准备，日期是2025-08-25。

我们采用鱼骨图和现场审查方法进行了调查。检查了空调系统记录、消毒记录和人员进出记录。发现在采样前一小时有维修人员进入更换了一个照明设备，且进入程序不完全符合要求。根本原因确定为维修人员着装程序执行不到位和临时维修作业管理不当。

影响评估显示，浮游菌超标点位于房间边缘，未直接接触产品或关键表面。同时监测的沉降菌、表面接触菌均在限值内。产品批次的无菌测试结果也合格。质量评审认为此偏差不会影响产品质量，批次可以放行。

采取的措施包括：
1. 增加该区域的清洁消毒频率
2. 重新培训维修人员洁净区行为规范
3. 修订临时维修作业程序，增加QA审批环节
4. 优化洁净区人员流动路线
5. 增加环境监测频率直至连续3次结果达标

监测结果已恢复正常，建议关闭此调查并放行相关批次。
```

## 触发插件指令

在Dify平台上与AI助手对话时，可以使用以下指令触发插件功能：

### 1. 触发数据提取工具

```
请提取我们对话中的GMP报告数据
```

这将调用`gmp_extract_data`工具，从对话历史中提取结构化的GMP报告数据。

### 2. 触发HTML预览工具

```
请根据我们的对话内容生成报告预览
```

这将调用`gmp_preview_report`工具，生成HTML格式的报告预览。

### 3. 触发PDF生成工具

```
请生成PDF格式的GMP调查报告
```

这将调用`gmp_generate_pdf`工具，生成并提供可下载的PDF格式报告。

## 测试流程

1. 在Dify平台创建应用并启用拜耳GMP报告生成器插件
2. 配置工作流，将`sys.conversation_id`绑定到插件的对话ID参数
3. 复制系统提示词到应用的对话设置中
4. 开始一个新对话，复制场景1-5中的任一用户输入
5. 根据AI助手的提示，提供补充信息
6. 使用上述触发指令测试各插件功能
7. 验证提取的数据、HTML预览和PDF报告是否符合预期

## 常见问题与解决方案

1. **数据提取不完整**：确保对话中包含了所有必要的GMP报告信息
2. **PDF生成失败**：检查Spring服务是否正常运行，API密钥是否正确
3. **HTML预览显示异常**：检查报告数据中是否包含特殊字符或格式问题
4. **插件工具未被触发**：检查工作流配置，确保触发指令正确且插件已启用

## 开发调试提示

如需进一步调试插件功能，可以：

1. 查看插件服务日志：`python -m main`命令启动插件服务后查看控制台输出
2. 使用测试脚本：`python test_tools.py --sample-data`测试各工具功能
3. 测试Spring连接：`python test_spring_connection.py`验证后端服务连接
